{% extends 'base.html' %}
{% load static %}

{% block title %}üì§ Xu·∫•t kho n·ªôi b·ªô{% endblock %}
{% block page_title %}üì§ Xu·∫•t kho n·ªôi b·ªô{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-exchange-alt me-2"></i>Th√¥ng tin phi·∫øu xu·∫•t
                </h5>
            </div>
            <div class="card-body">
                <form method="post" id="xuatKhoForm">
                    {% csrf_token %}

                    <!-- Kho xu·∫•t & Kho nh·∫≠n -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Kho xu·∫•t <span class="text-danger">*</span></label>
                            <select name="kho_xuat" class="form-control" required>
                                <option value="">-- Ch·ªçn kho xu·∫•t --</option>
                                {% for kho in kho_list %}
                                <option value="{{ kho.id }}">{{ kho.ten_kho }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Kho nh·∫≠n <span class="text-danger">*</span></label>
                            <select name="kho_nhan" class="form-control" required>
                                <option value="">-- Ch·ªçn kho nh·∫≠n --</option>
                                {% for kho in kho_list %}
                                <option value="{{ kho.id }}">{{ kho.ten_kho }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <!-- Ghi ch√∫ -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">Ghi ch√∫</label>
                        <textarea name="ghi_chu" class="form-control" rows="2"></textarea>
                    </div>

                    <!-- Chi ti·∫øt s·∫£n ph·∫©m -->
                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="fw-bold">
                                <i class="fas fa-boxes me-2"></i>Chi ti·∫øt s·∫£n ph·∫©m
                            </h6>
                            <button type="button" class="btn btn-success btn-sm" id="addProduct">
                                <i class="fas fa-plus me-1"></i>Th√™m s·∫£n ph·∫©m
                            </button>
                        </div>

                        <!-- Header c·ªßa b·∫£ng -->
                        <div class="row mb-2 fw-bold text-muted small">
                            <div class="col-md-5">S·∫£n ph·∫©m <span class="text-danger">*</span></div>
                            <div class="col-md-3">Danh m·ª•c</div>
                            <div class="col-md-2">ƒê∆°n v·ªã</div>
                            <div class="col-md-1">S·ªë l∆∞·ª£ng</div>
                            <div class="col-md-1 text-center">X√≥a</div>
                        </div>

                        <div id="productDetails">
                            <div class="product-row row mb-3 align-items-center border-bottom pb-3">
                                <div class="col-md-5">
                                    <input type="text" name="ten_san_pham" class="form-control ten-san-pham"
                                           placeholder="Nh·∫≠p t√™n s·∫£n ph·∫©m..." list="sanPhamList" required>
                                    <datalist id="sanPhamList">
                                        {% for sp in san_pham_list %}
                                        <option value="{{ sp.ten_san_pham }}"
                                                data-danhmuc="{{ sp.danh_muc.ten_danh_muc }}"
                                                data-donvitinh="{{ sp.don_vi_tinh.ten_don_vi }}">
                                        {% endfor %}
                                    </datalist>
                                </div>
                                <div class="col-md-3">
                                    <input type="text" name="danh_muc" class="form-control danh-muc-input" readonly>
                                </div>
                                <div class="col-md-2">
                                    <input type="text" name="don_vi_tinh" class="form-control don-vi-tinh-input" readonly>
                                </div>
                                <div class="col-md-1">
                                    <input type="number" name="so_luong" class="form-control so-luong" min="1" required>
                                </div>
                                <div class="col-md-1 text-center">
                                    <button type="button" class="btn btn-danger btn-sm remove-product" disabled title="X√≥a d√≤ng">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- N√∫t h√†nh ƒë·ªông -->
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>L∆∞u phi·∫øu xu·∫•t
                        </button>
                        <button type="reset" class="btn btn-outline-secondary">
                            <i class="fas fa-redo me-2"></i>L√†m m·ªõi
                        </button>
                    </div>

                </form>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const addBtn = document.getElementById('addProduct');
    const productDetails = document.getElementById('productDetails');

    // Th√™m d√≤ng s·∫£n ph·∫©m m·ªõi
    addBtn.addEventListener('click', function() {
        const newRow = document.querySelector('.product-row').cloneNode(true);
        const inputs = newRow.querySelectorAll('input');
        inputs.forEach(input => {
            input.value = '';
            input.removeAttribute('disabled');
        });
        newRow.querySelector('.remove-product').removeAttribute('disabled');
        productDetails.appendChild(newRow);
    });

    // X√≥a d√≤ng s·∫£n ph·∫©m
    productDetails.addEventListener('click', function(e) {
        if (e.target.closest('.remove-product')) {
            if (document.querySelectorAll('.product-row').length > 1) {
                e.target.closest('.product-row').remove();
            }
        }
    });

    // T·ª± ƒë·ªông ƒëi·ªÅn th√¥ng tin khi ch·ªçn s·∫£n ph·∫©m t·ª´ datalist
    productDetails.addEventListener('input', function(e) {
        if (e.target.classList.contains('ten-san-pham')) {
            const productName = e.target.value;
            const row = e.target.closest('.product-row');
            const danhMucInput = row.querySelector('.danh-muc-input');
            const donViTinhInput = row.querySelector('.don-vi-tinh-input');

            if (productName) {
                // T√¨m s·∫£n ph·∫©m trong datalist
                const datalist = document.getElementById('sanPhamList');
                const options = datalist.options;
                let foundProduct = null;

                for (let option of options) {
                    if (option.value === productName) {
                        foundProduct = option;
                        break;
                    }
                }

                if (foundProduct && foundProduct.dataset.id) {
                    // T·ª± ƒë·ªông ƒëi·ªÅn danh m·ª•c, ƒë∆°n v·ªã t√≠nh
                    const danhMuc = foundProduct.dataset.danhmuc;
                    const donViTinh = foundProduct.dataset.donvitinh;

                    if (danhMuc && !danhMucInput.value) {
                        danhMucInput.value = danhMuc;
                    }

                    if (donViTinh && !donViTinhInput.value) {
                        donViTinhInput.value = donViTinh;
                    }
                }
            }
        }
    });
});
</script>

<style>
.ten-san-pham:focus, .danh-muc-input:focus, .don-vi-tinh-input:focus, .so-luong:focus {
    border-color: #3498db;
    box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
}
.product-row {
    transition: all 0.3s ease;
}
.product-row:hover {
    background-color: #f8f9fa;
    border-radius: 8px;
    padding: 8px 0;
}
.remove-product {
    width: 32px;
    height: 32px;
    padding: 0;
    display: inline-flex;
    align-items: center;
    justify-content: center;
}
.remove-product i {
    font-size: 14px;
}
</style>
{% endblock %}
{{ block.super }}