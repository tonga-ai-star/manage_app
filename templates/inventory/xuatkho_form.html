{% extends 'base.html' %}
{% load static %}

{% block title %}T·∫°o phi·∫øu xu·∫•t kho{% endblock %}
{% block page_title %}üì§ T·∫°o phi·∫øu xu·∫•t kho{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-edit me-2"></i>Th√¥ng tin phi·∫øu xu·∫•t
                </h5>
            </div>
            <div class="card-body">
                <form method="post" id="xuatKhoForm">
                    {% csrf_token %}

                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label fw-bold">Kh√°ch h√†ng <span class="text-danger">*</span></label>
                                <input type="text" name="ten_khach_hang" class="form-control ten-khach-hang"
                                       placeholder="Nh·∫≠p t√™n kh√°ch h√†ng..." list="khachHangList"
                                       value="{{ form.ten_khach_hang.value|default:'' }}" required>
                                <datalist id="khachHangList">
                                    {% for kh in khach_hang_list %}
                                    <option value="{{ kh.ten_khach_hang }}">
                                    {% endfor %}
                                </datalist>
                                <small class="text-muted">Nh·∫≠p t√™n kh√°ch h√†ng ho·∫∑c ch·ªçn t·ª´ danh s√°ch</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label fw-bold">M√£ phi·∫øu</label>
                                <input type="text" class="form-control" value="T·ª± ƒë·ªông" disabled>
                                <small class="text-muted">M√£ phi·∫øu s·∫Ω ƒë∆∞·ª£c t·∫°o t·ª± ƒë·ªông</small>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="form-group">
                                <label class="form-label fw-bold">Ghi ch√∫</label>
                                {{ form.ghi_chu }}
                            </div>
                        </div>
                    </div>

                    <!-- Chi ti·∫øt s·∫£n ph·∫©m -->
                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="fw-bold">
                                <i class="fas fa-boxes me-2"></i>Chi ti·∫øt s·∫£n ph·∫©m
                            </h6>
                            <button type="button" class="btn btn-success btn-sm" id="addProduct">
                                <i class="fas fa-plus me-1"></i>Th√™m s·∫£n ph·∫©m
                            </button>
                        </div>

                        <div id="productDetails">
                            <div class="product-row row mb-3 border-bottom pb-3">
                                <div class="col-md-3">
                                    <label class="form-label small fw-bold">S·∫£n ph·∫©m <span class="text-danger">*</span></label>
                                    <input type="text" name="ten_san_pham" class="form-control ten-san-pham"
                                           placeholder="Nh·∫≠p t√™n s·∫£n ph·∫©m..." list="sanPhamList" required>
                                    <datalist id="sanPhamList">
                                        {% for sp in san_pham_list %}
                                        <option value="{{ sp.ten_san_pham }}"
                                                data-id="{{ sp.id }}"
                                                data-danhmuc="{{ sp.danh_muc.ten_danh_muc }}"
                                                data-donvitinh="{{ sp.don_vi_tinh.ten_don_vi }}"
                                                data-giaban="{{ sp.gia_ban }}"
                                                data-tonkho="{{ sp.ton_kho }}">
                                        {% endfor %}
                                    </datalist>
                                    <small class="ton-kho-info text-muted small" style="display: none;"></small>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label small fw-bold">Danh m·ª•c <span class="text-danger">*</span></label>
                                    <input type="text" name="danh_muc" class="form-control danh-muc-input"
                                           placeholder="Nh·∫≠p danh m·ª•c" list="danhMucList" required>
                                    <datalist id="danhMucList">
                                        {% for dm in danh_muc_list %}
                                        <option value="{{ dm.ten_danh_muc }}">
                                        {% endfor %}
                                    </datalist>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label small fw-bold">ƒê∆°n v·ªã t√≠nh <span class="text-danger">*</span></label>
                                    <input type="text" name="don_vi_tinh" class="form-control don-vi-tinh-input"
                                           placeholder="Nh·∫≠p ƒë∆°n v·ªã" list="donViTinhList" required>
                                    <datalist id="donViTinhList">
                                        {% for dvt in don_vi_tinh_list %}
                                        <option value="{{ dvt.ten_don_vi }}">
                                        {% endfor %}
                                    </datalist>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label small fw-bold">S·ªë l∆∞·ª£ng <span class="text-danger">*</span></label>
                                    <input type="number" name="so_luong" class="form-control so-luong"
                                           placeholder="SL" min="1" required onchange="calculateTotal()">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label small fw-bold">ƒê∆°n gi√° <span class="text-danger">*</span></label>
                                    <div class="input-group">
                                        <input type="number" name="don_gia" class="form-control don-gia"
                                               placeholder="ƒê∆°n gi√°" step="0.01" min="0" required
                                               onchange="calculateTotal()">
                                        <span class="input-group-text">‚Ç´</span>
                                    </div>
                                </div>
                                <div class="col-md-1">
                                    <label class="form-label small fw-bold">Th√†nh ti·ªÅn</label>
                                    <input type="text" class="form-control total" value="0" readonly>
                                </div>
                                <div class="col-md-1">
                                    <label class="form-label small text-white">.</label>
                                    <button type="button" class="btn btn-danger btn-sm remove-product" disabled>
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- T·ªïng ti·ªÅn -->
                    <div class="row mb-4">
                        <div class="col-md-6 offset-md-6">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <strong class="fs-5">T·ªïng c·ªông:</strong>
                                        <strong class="fs-4 text-success" id="grandTotal">0‚Ç´</strong>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary-custom">
                            <i class="fas fa-save me-2"></i>L∆∞u phi·∫øu xu·∫•t
                        </button>
                        <a href="{% url 'inventory:danh_sach_xuat' %}" class="btn btn-secondary">
                            <i class="fas fa-times me-2"></i>H·ªßy
                        </a>
                        <button type="reset" class="btn btn-outline-secondary">
                            <i class="fas fa-redo me-2"></i>L√†m m·ªõi
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <!-- Th√¥ng tin h∆∞·ªõng d·∫´n -->
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="fas fa-info-circle me-2"></i>H∆∞·ªõng d·∫´n
                </h6>
            </div>
            <div class="card-body">
                <div class="alert alert-warning">
                    <h6><i class="fas fa-exclamation-triangle me-2"></i>L∆∞u √Ω quan tr·ªçng:</h6>
                    <ul class="mb-0 ps-3">
                        <li>Nh·∫≠p t√™n kh√°ch h√†ng ho·∫∑c ch·ªçn t·ª´ danh s√°ch g·ª£i √Ω</li>
                        <li>Nh·∫≠p t√™n s·∫£n ph·∫©m ho·∫∑c ch·ªçn t·ª´ danh s√°ch c√≥ s·∫µn</li>
                        <li>Nh·∫≠p danh m·ª•c ho·∫∑c ch·ªçn t·ª´ danh s√°ch g·ª£i √Ω</li>
                        <li>Nh·∫≠p ƒë∆°n v·ªã t√≠nh ho·∫∑c ch·ªçn t·ª´ danh s√°ch g·ª£i √Ω</li>
                        <li>S·ªë l∆∞·ª£ng xu·∫•t kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° t·ªìn kho</li>
                        <li>ƒê∆°n gi√° m·∫∑c ƒë·ªãnh l·∫•y t·ª´ gi√° b√°n c·ªßa s·∫£n ph·∫©m</li>
                        <li>Ki·ªÉm tra k·ªπ th√¥ng tin tr∆∞·ªõc khi l∆∞u</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Th·ªëng k√™ nhanh -->
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="fas fa-chart-bar me-2"></i>Th·ªëng k√™ nhanh
                </h6>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between mb-2">
                    <span>S·ªë s·∫£n ph·∫©m:</span>
                    <strong id="productCount">0</strong>
                </div>
                <div class="d-flex justify-content-between mb-2">
                    <span>T·ªïng s·ªë l∆∞·ª£ng:</span>
                    <strong id="totalQuantity">0</strong>
                </div>
                <hr>
                <div class="d-flex justify-content-between">
                    <span class="fw-bold">T·ªïng ti·ªÅn:</span>
                    <strong class="text-success" id="summaryTotal">0‚Ç´</strong>
                </div>
            </div>
        </div>

        <!-- Th√¥ng tin kh√°ch h√†ng -->
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="fas fa-users me-2"></i>Kh√°ch h√†ng g·∫ßn ƒë√¢y
                </h6>
            </div>
            <div class="card-body">
                {% if khach_hang_list %}
                    <div class="list-group list-group-flush">
                        {% for kh in khach_hang_list|slice:":5" %}
                        <div class="list-group-item px-0">
                            <div class="fw-bold">{{ kh.ten_khach_hang }}</div>
                            <small class="text-muted">{{ kh.dien_thoai }}</small>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-muted text-center mb-0">Ch∆∞a c√≥ kh√°ch h√†ng</p>
                {% endif %}
            </div>
        </div>

        <!-- Danh m·ª•c s·∫£n ph·∫©m -->
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="fas fa-tags me-2"></i>Danh m·ª•c s·∫£n ph·∫©m
                </h6>
            </div>
            <div class="card-body">
                {% if danh_muc_list %}
                    <div class="list-group list-group-flush">
                        {% for dm in danh_muc_list|slice:":8" %}
                        <div class="list-group-item px-0">
                            <div class="fw-bold">{{ dm.ten_danh_muc }}</div>
                            <small class="text-muted">{{ dm.mo_ta|default:"Kh√¥ng c√≥ m√¥ t·∫£" }}</small>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-muted text-center mb-0">Ch∆∞a c√≥ danh m·ª•c</p>
                {% endif %}
            </div>
        </div>

        <!-- ƒê∆°n v·ªã t√≠nh -->
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="fas fa-balance-scale me-2"></i>ƒê∆°n v·ªã t√≠nh
                </h6>
            </div>
            <div class="card-body">
                {% if don_vi_tinh_list %}
                    <div class="d-flex flex-wrap gap-2">
                        {% for dvt in don_vi_tinh_list %}
                        <span class="badge bg-info">{{ dvt.ten_don_vi }}</span>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-muted text-center mb-0">Ch∆∞a c√≥ ƒë∆°n v·ªã t√≠nh</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const addBtn = document.getElementById('addProduct');
    const productDetails = document.getElementById('productDetails');

    // Th√™m d√≤ng s·∫£n ph·∫©m m·ªõi
    addBtn.addEventListener('click', function() {
        const newRow = document.querySelector('.product-row').cloneNode(true);
        const inputs = newRow.querySelectorAll('input');
        inputs.forEach(input => {
            input.value = '';
            input.removeAttribute('disabled');
        });
        newRow.querySelector('.remove-product').removeAttribute('disabled');
        newRow.querySelector('.total').value = '0';
        newRow.querySelector('.ton-kho-info').style.display = 'none';
        productDetails.appendChild(newRow);
        updateStatistics();
    });

    // X√≥a d√≤ng s·∫£n ph·∫©m
    productDetails.addEventListener('click', function(e) {
        if (e.target.classList.contains('remove-product')) {
            if (document.querySelectorAll('.product-row').length > 1) {
                e.target.closest('.product-row').remove();
                calculateTotal();
                updateStatistics();
            }
        }
    });

    // T·ª± ƒë·ªông ƒëi·ªÅn th√¥ng tin khi ch·ªçn s·∫£n ph·∫©m t·ª´ datalist
    productDetails.addEventListener('input', function(e) {
        if (e.target.classList.contains('ten-san-pham')) {
            const productName = e.target.value;
            const row = e.target.closest('.product-row');
            const danhMucInput = row.querySelector('.danh-muc-input');
            const donViTinhInput = row.querySelector('.don-vi-tinh-input');
            const donGiaInput = row.querySelector('.don-gia');
            const tonKhoInfo = row.querySelector('.ton-kho-info');
            const soLuongInput = row.querySelector('.so-luong');

            if (productName) {
                // T√¨m s·∫£n ph·∫©m trong datalist
                const datalist = document.getElementById('sanPhamList');
                const options = datalist.options;
                let foundProduct = null;

                for (let option of options) {
                    if (option.value === productName) {
                        foundProduct = option;
                        break;
                    }
                }

                if (foundProduct && foundProduct.dataset.id) {
                    // T·ª± ƒë·ªông ƒëi·ªÅn danh m·ª•c, ƒë∆°n v·ªã t√≠nh, gi√° b√°n, t·ªìn kho
                    const danhMuc = foundProduct.dataset.danhmuc;
                    const donViTinh = foundProduct.dataset.donvitinh;
                    const giaBan = foundProduct.dataset.giaban;
                    const tonKho = foundProduct.dataset.tonkho;

                    if (danhMuc && !danhMucInput.value) {
                        danhMucInput.value = danhMuc;
                    }

                    if (donViTinh && !donViTinhInput.value) {
                        donViTinhInput.value = donViTinh;
                    }

                    if (giaBan && !donGiaInput.value) {
                        donGiaInput.value = giaBan;
                    }

                    // Hi·ªÉn th·ªã th√¥ng tin t·ªìn kho
                    if (tonKho) {
                        tonKhoInfo.textContent = `T·ªìn kho: ${tonKho}`;
                        tonKhoInfo.style.display = 'block';
                        tonKhoInfo.className = 'ton-kho-info small ' + (tonKho > 0 ? 'text-success' : 'text-danger');

                        // ƒê·∫∑t gi√° tr·ªã t·ªëi ƒëa cho s·ªë l∆∞·ª£ng
                        soLuongInput.setAttribute('max', tonKho);
                    }
                } else {
                    // ·∫®n th√¥ng tin t·ªìn kho n·∫øu kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m
                    tonKhoInfo.style.display = 'none';
                    danhMucInput.value = '';
                    donViTinhInput.value = '';
                }

                calculateTotal();
            }
        }
    });

    // Ki·ªÉm tra s·ªë l∆∞·ª£ng kh√¥ng v∆∞·ª£t qu√° t·ªìn kho
    productDetails.addEventListener('input', function(e) {
        if (e.target.classList.contains('so-luong')) {
            const quantity = parseInt(e.target.value) || 0;
            const row = e.target.closest('.product-row');
            const productName = row.querySelector('.ten-san-pham').value;
            const tonKhoInfo = row.querySelector('.ton-kho-info');

            if (productName && tonKhoInfo.style.display !== 'none') {
                // L·∫•y t·ªìn kho t·ª´ datalist
                const datalist = document.getElementById('sanPhamList');
                const options = datalist.options;
                let tonKho = 0;

                for (let option of options) {
                    if (option.value === productName) {
                        tonKho = parseInt(option.dataset.tonkho) || 0;
                        break;
                    }
                }

                if (quantity > tonKho) {
                    e.target.classList.add('is-invalid');
                    tonKhoInfo.classList.remove('text-success');
                    tonKhoInfo.classList.add('text-danger', 'fw-bold');
                    tonKhoInfo.textContent = `T·ªìn kho: ${tonKho} (V∆∞·ª£t qu√° t·ªìn kho!)`;
                } else {
                    e.target.classList.remove('is-invalid');
                    tonKhoInfo.classList.remove('text-danger', 'fw-bold');
                    tonKhoInfo.classList.add('text-success');
                    tonKhoInfo.textContent = `T·ªìn kho: ${tonKho}`;
                }
            }

            calculateTotal();
            updateStatistics();
        }
    });

    // T√≠nh to√°n t·ªïng ti·ªÅn
    window.calculateTotal = function() {
        let grandTotal = 0;
        document.querySelectorAll('.product-row').forEach(row => {
            const quantity = parseFloat(row.querySelector('.so-luong').value) || 0;
            const price = parseFloat(row.querySelector('.don-gia').value) || 0;
            const total = quantity * price;
            row.querySelector('.total').value = total.toLocaleString('vi-VN') + '‚Ç´';
            grandTotal += total;
        });
        document.getElementById('grandTotal').textContent = grandTotal.toLocaleString('vi-VN') + '‚Ç´';
        document.getElementById('summaryTotal').textContent = grandTotal.toLocaleString('vi-VN') + '‚Ç´';
    };

    // C·∫≠p nh·∫≠t th·ªëng k√™
    window.updateStatistics = function() {
        const productCount = document.querySelectorAll('.product-row').length;
        let totalQuantity = 0;

        document.querySelectorAll('.so-luong').forEach(input => {
            totalQuantity += parseFloat(input.value) || 0;
        });

        document.getElementById('productCount').textContent = productCount;
        document.getElementById('totalQuantity').textContent = totalQuantity;
    };

    // Kh·ªüi t·∫°o
    calculateTotal();
    updateStatistics();

    // X·ª≠ l√Ω s·ª± ki·ªán input cho c√°c field
    document.addEventListener('input', function(e) {
        if (e.target.classList.contains('so-luong') || e.target.classList.contains('don-gia')) {
            calculateTotal();
            updateStatistics();
        }
    });
});
</script>

<style>
.ten-khach-hang:focus, .ten-san-pham:focus, .danh-muc-input:focus, .don-vi-tinh-input:focus, .so-luong:focus, .don-gia:focus {
    border-color: #3498db;
    box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
}
.product-row {
    transition: all 0.3s ease;
}
.product-row:hover {
    background-color: #f8f9fa;
    border-radius: 8px;
    padding: 10px;
}
.list-group-item {
    border: none;
    padding: 8px 0;
}
.is-invalid {
    border-color: #dc3545;
    box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
}
</style>
{% endblock %}