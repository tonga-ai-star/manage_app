{% extends 'base.html' %}
{% load static %}

{% block title %}üì§ Xu·∫•t kho n·ªôi b·ªô{% endblock %}
{% block page_title %}üì§ Xu·∫•t kho n·ªôi b·ªô{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-exchange-alt me-2"></i>Th√¥ng tin phi·∫øu xu·∫•t
                </h5>
            </div>

            <div class="card-body">
                <form method="post" id="xuatKhoForm">
                    {% csrf_token %}

                    <!-- Kho xu·∫•t & Kho nh·∫≠n -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Kho xu·∫•t <span class="text-danger">*</span></label>
                            <select name="kho_xuat" class="form-control" required>
                                <option value="">-- Ch·ªçn kho xu·∫•t --</option>
                                {% for kho in kho_list %}
                                <option value="{{ kho.id }}">{{ kho.ten_kho }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Kho nh·∫≠n <span class="text-danger">*</span></label>
                            <select name="kho_nhan" class="form-control" required>
                                <option value="">-- Ch·ªçn kho nh·∫≠n --</option>
                                {% for kho in kho_list %}
                                <option value="{{ kho.id }}">{{ kho.ten_kho }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <!-- Ghi ch√∫ -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">Ghi ch√∫</label>
                        <textarea name="ghi_chu" class="form-control" rows="2"></textarea>
                    </div>

                    <!-- Chi ti·∫øt s·∫£n ph·∫©m -->
                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="fw-bold">
                                <i class="fas fa-boxes me-2"></i>Chi ti·∫øt s·∫£n ph·∫©m
                            </h6>
                            <button type="button" class="btn btn-success btn-sm" id="addProduct">
                                <i class="fas fa-plus me-1"></i>Th√™m s·∫£n ph·∫©m
                            </button>
                        </div>

                        <div id="productDetails">
                            <div class="product-row row mb-3 border-bottom pb-3">

                                <div class="col-md-5">
                                    <label class="form-label small fw-bold">S·∫£n ph·∫©m <span class="text-danger">*</span></label>
                                    <input type="text" name="ten_san_pham" class="form-control ten-san-pham"
                                           placeholder="Nh·∫≠p t√™n s·∫£n ph·∫©m..." list="sanPhamList" required>

                                    <datalist id="sanPhamList">
                                        {% for sp in san_pham_list %}
                                        <option value="{{ sp.ten_san_pham }}"
                                                data-danhmuc="{{ sp.danh_muc.ten_danh_muc }}"
                                                data-donvitinh="{{ sp.don_vi_tinh.ten_don_vi }}">
                                        {% endfor %}
                                    </datalist>
                                </div>

                                <div class="col-md-3">
                                    <label class="form-label small fw-bold">Danh m·ª•c</label>
                                    <input type="text" name="danh_muc" class="form-control danh-muc-input" readonly>
                                </div>

                                <div class="col-md-2">
                                    <label class="form-label small fw-bold">ƒê∆°n v·ªã</label>
                                    <input type="text" name="don_vi_tinh" class="form-control don-vi-tinh-input" readonly>
                                </div>

                                <div class="col-md-2">
                                    <label class="form-label small fw-bold">S·ªë l∆∞·ª£ng</label>
                                    <input type="number" name="so_luong" class="form-control so-luong" min="1" required>
                                </div>

                                <div class="col-md-1 mt-4">
                                    <button type="button" class="btn btn-danger btn-sm remove-product" disabled>
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>

                            </div>
                        </div>
                    </div>

                    <!-- N√∫t h√†nh ƒë·ªông -->
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>L∆∞u phi·∫øu xu·∫•t
                        </button>
                        <button type="reset" class="btn btn-outline-secondary">
                            <i class="fas fa-redo me-2"></i>L√†m m·ªõi
                        </button>
                    </div>

                </form>
            </div>
        </div>
    </div>

    <!-- Sidebar th·ªëng k√™ -->
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0"><i class="fas fa-chart-bar me-2"></i>Th·ªëng k√™</h6>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between mb-2">
                    <span>S·ªë s·∫£n ph·∫©m:</span><strong id="productCount">0</strong>
                </div>
                <div class="d-flex justify-content-between mb-2">
                    <span>T·ªïng s·ªë l∆∞·ª£ng:</span><strong id="totalQuantity">0</strong>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {

    const addBtn = document.getElementById('addProduct');
    const productDetails = document.getElementById('productDetails');

    // Th√™m d√≤ng
    addBtn.addEventListener('click', function() {
        const newRow = document.querySelector('.product-row').cloneNode(true);
        newRow.querySelectorAll('input').forEach(i => i.value = "");
        newRow.querySelector('.remove-product').disabled = false;
        productDetails.appendChild(newRow);
        updateStatistics();
    });

    // Xo√° d√≤ng
    productDetails.addEventListener('click', function(e) {
        if (e.target.classList.contains('remove-product')) {
            if (document.querySelectorAll('.product-row').length > 1) {
                e.target.closest('.product-row').remove();
                updateStatistics();
            }
        }
    });

    // T·ª± ƒë·ªông ƒëi·ªÅn danh m·ª•c + ƒë∆°n v·ªã
    productDetails.addEventListener('input', function(e) {
        if (e.target.classList.contains('ten-san-pham')) {

            const row = e.target.closest('.product-row');
            const productName = e.target.value;

            const datalist = document.getElementById('sanPhamList');
            const option = [...datalist.options].find(o => o.value === productName);

            if (option) {
                row.querySelector('.danh-muc-input').value = option.dataset.danhmuc || "";
                row.querySelector('.don-vi-tinh-input').value = option.dataset.donvitinh || "";
            }

            updateStatistics();
        }
    });

    // C·∫≠p nh·∫≠t th·ªëng k√™
    function updateStatistics() {
        const rows = document.querySelectorAll('.product-row');

        document.getElementById('productCount').textContent = rows.length;

        let totalQty = 0;
        rows.forEach(r => totalQty += parseFloat(r.querySelector('.so-luong').value) || 0);
        document.getElementById('totalQuantity').textContent = totalQty;
    }

    document.addEventListener('input', updateStatistics);
});
</script>

{% endblock %}
